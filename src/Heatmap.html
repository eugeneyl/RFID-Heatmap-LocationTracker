<!DOCTYPE html>

<head>
    <meta name="viewport" id="vp" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width" />
    <meta charset="utf-8" />
    <script>window.$ = window.jQuery = require('../helper/jquery-3.4.1.min.js');</script>
    <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <!-- <script src="https://code.jquery.com/jquery-1.8.0.min.js"></script> -->
    <link rel="stylesheet" href="../helper/jquery-ui/jquery-ui.css">
    <script src="../helper/jquery-ui/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="../styles/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
        integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
        crossorigin=""></script>
    <script src="../helper/Leaflet.ImageOverlay.Rotated.js"></script>
    <script src="../helper/leaflet-heat.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet">
    <script>if (window.module) module = window.module;</script>
</head>

<link rel="stylesheet" href="../styles/heatmap.css" />

<body>
    <div>
        <div id = mapWrapper>
            <div id="mapid"></div>
            <div id="button-wrapper">
                <input type="button" value="Tracker" class = "mode" onclick="window.location.href = 'LocationTracker.html';"/>
            </div>
        </div>
    </div>
    <div style="overflow: hidden; opacity:90%">
        <div class="eventBox">
            <div class="eventTitle">
                Tyre Expo Asia 2019 | Day 1
            </div>
        </div>
        <div class="topControls" id = "intervalControls">
            <div class='ControlsContainer'>
                <div class = "slideTextContainer">
                    <span class=slideText> Start: </span> &nbsp;
                </div>
                <div class="inputBoxContainer">
                    <input type="number" class="inputBox" id="intStartDay" value=1 max=3 min=1>
                    <br/>
                    Day
                </div>
                <div class="inputBoxContainer">
                    <input type="text" class="inputBox" id="intStartTime"
                        value="0800">
                    <br/>
                    Time
                </div>
            </div>
            <div class='ControlsContainer'>
                <div class = "slideTextContainer">
                    <span class=slideText> End: </span> &nbsp;
                </div>
                <div class="inputBoxContainer">
                    <input type="number" class="inputBox" id="intEndDay" value=1 max=3 min=1>
                    <br/>
                    Day
                </div>
                <div class="inputBoxContainer">
                    <input type="text" class="inputBox" id="intEndTime" value="0800">
                    <br/>
                    Time
                </div>
            </div>
            <div class='ControlsContainer'>
                <div class = "intervalTextContainer">                
                    <span class=slideText> Intervals: </span> &nbsp; <input type = "text" class="inputBox" id="interval"
                        value="0"> <span class=minText>min</span>
                </div>
            </div>
        </div>
        <div class="topControls" id = "specificControls">
            <div class='ControlsContainer'>
                <span class=slideText> Day: </span> &nbsp;
                <input type="number" class="inputBox" id="specDay" value=1 max=3 min=1>
            </div>
            <div class='ControlsContainer'>
                <span class=slideText> Time: </span> &nbsp; <input type="text" class="inputBox" id="specTime"
                    value="0800">
            </div>
        </div>
    </div>
    <div>
        <div class="bottomControls">
            <div class="navButtonContainer">
                <img id="prevDay" class="navButtons" src="../icon/prev.svg" title="Jump to previous day" />
            </div>
            <div class="navButtonContainer">
                <img id="toggleIcon" class="navButtons" src="../icon/play.svg" title="Play" />
            </div>
            <div class="navButtonContainer">
                <img id="nextDay" class="navButtons" src="../icon/next.svg" title="Jump to next day" />
            </div>
            <div class="navButtonContainer">
                <span id="speed" class="navtext" title="Playback speed">1x</span>
            </div>
            <div class="navButtonContainer">
                <img id="stepBackward" class="navButtons" src="../icon/skipback.svg" title="Skip backward" />
            </div>
            <div class="navButtonContainer">
                <img id="stepForward" class="navButtons" src="../icon/skipforward.svg" title="Skip forward" />
            </div>
            <div class="toggleBox">
                <span class=slideText> Interval &nbsp;</span> 
                <label class="switch">
                    <input type="checkbox" id="intervalToggle">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        <div class='sliderContainer'>
            <div class = "sliderRange" id="intervalSlider"></div>
            <div class = "sliderRange" id="specificSlider"></div>
        </div>
        <!-- <div class='sliderContainer' id=specificRange>
            <input type="range" min="0" max="1742" value="0" step="1" class="slider" id="specificSlider">
        </div> -->
    </div>
</body>

<script src="Heatmap/HMDataSet.js"></script>
<script src="Util/HelperFunctions.js"></script>
<script> //map initialisation
    var point1 = L.latLng(1.334227, 103.955138),
        point3 = L.latLng(1.331125, 103.955138),
        point2 = L.latLng(1.334227, 103.961874);
    var bounds = L.latLngBounds(point2, point3);

    var mymap = L.map('mapid', {
        center: [1.332469, 103.957427],
        zoom: 18.42,
        // maxBounds: bounds
    });

    mymap.setMaxBounds(bounds);

    L.tileLayer('', {
        'attribution': 'Map data &copy; OpenStreetMap contributors',
        maxZoom: 22,
        minZoom: 18.4,
    }).addTo(mymap);

    // L.tileLayer('https://api.tiles.mapbox.c../{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
    //     attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
    //     maxZoom: 22,
    //     minZoom: 17.5,
    //     id: 'mapbox.streets',
    //     accessToken: 'pk.eyJ1IjoiZXVnZW5leWwiLCJhIjoiY2p3azluNnliMG82cTN5cDYxaHFuYnhpNSJ9.bcd9AxfVztbmUqER-SCqnA'
    // }).addTo(mymap);

    // mymap.MaxBounds(bounds);
    // var marker1 = L.marker(point1, {draggable: true} ).addTo(mymap),
    //     marker2 = L.marker(point2, {draggable: true} ).addTo(mymap),
    //     marker3 = L.marker(point3, {draggable: true} ).addTo(mymap);

    var overlay = L.imageOverlay.rotated("../icon/Map.svg", point1, point2, point3, {
        opacity: 1,
        interactive: true,
        attribution: "Floor plan of tyreexpo"
    }).addTo(mymap);

    //For repositioning the image overlay
    // function repositionImage() {
    // 	overlay.reposition(marker1.getLatLng(), marker2.getLatLng(), marker3.getLatLng());
    // };

    // marker1.on('drag dragend', repositionImage);
    // marker2.on('drag dragend', repositionImage);
    // marker3.on('drag dragend', repositionImage);

    //For getting specific/center coordinates
    // var popup = L.popup();
    // function onMapClick(e) {
    //     alert(mymap.getCenter());
    //     popup
    //         .setLatLng(e.latlng)
    //         .setContent("You clicked the map at " + e.latlng.toString())
    //         .openOn(mymap);
    // }

    // mymap.on('click', onMapClick);
    
    var startTime = parseDateTime(parseInt(0));
    var endTime = parseDateTime(parseInt(0));
    var dataSet = [];
    var alleyCount = [0, 0, 0, 0, 0, 0, 0, 0];

    parsedData.forEach(function (data) {
    var testTotal = parseMinute(data.time);
        if (testTotal <= 0 && testTotal >= 0) {
            alleyCount[data.alley] += data.count;
            for (var i = 0; i < data.count; i++) {
                dataSet.push(data.coordinates);
            }
        }
    });

    var heat = L.heatLayer(dataSet, { radius: 95, maxZoom: 21 }).addTo(mymap);
    var popupList = [];
    for (var i = 0; i < 8; i++) {
        var popup = L.popup({
            autoClose: false,
            closeOnEscapeKey: false,
            closeOnClick: false,
            closeButton: false
        }
        );
        popup.setLatLng(L.latLng([alleyCoordinates[i].lat, alleyCoordinates[i].long]))
            .setContent("<b>" + alleyCount[i] + "</b>")
            .openOn(mymap);
        popupList.push(popup);
    }
</script>
<script> //UI features
    function update(values) {
        var startTime = parseDateTime(parseInt(values[0]));
        var endTime = parseDateTime(parseInt(values[1]));
        var intensity = 1/(values[1] - values[0] + 1);

        intStartDay.value = startTime.day;
        intStartTime.value = parseTimeString(startTime.min, startTime.hour);
        intEndDay.value = endTime.day;
        intEndTime.value = parseTimeString(endTime.min, endTime.hour);
        interval.value = parseInt(values[1]) - parseInt(values[0]);
        specDay.value = startTime.day;
        specTime.value = parseTimeString(startTime.min, startTime.hour);

        dataSet = [];
        alleyCount = [0, 0, 0, 0, 0, 0, 0, 0];
        parsedData.forEach(function (data) {
            var testTotal = parseMinute(data.time);
            if (testTotal <= values[1] && testTotal >= values[0]) {
                alleyCount[data.alley] += data.count;
                data.coordinates[2] = intensity;
                for (var i = 0; i < data.count; i++) {
                    dataSet.push(data.coordinates);
                }
            }
        });
        // heat.setOptions({max: difference});
        heat.setLatLngs(dataSet);
        for (var i = 0; i < popupList.length; i++) {
            popupList[i].setContent("<b>" + alleyCount[i] + "</b>");
        }
        if (startTime.day == endTime.day) {
            $(".eventTitle").html("Tyre Expo Asia 2019  |  Day " + startTime.day);
        } else {
            $(".eventTitle").html("Tyre Expo Asia 2019  |  Day " + startTime.day + " - " 
                + endTime.day);
        }
    }

    $( function() {
        $( "#intervalSlider" ).slider({
        range: true,
        min: 0,
        max: 1742,
        values: [ 0, 0 ],
        change: function(event, ui) {
            update(ui.values);
            if (hasInterval) {
                $("#specificSlider").slider("value", ui.values[0]);
            }
        },
        slide: function(event, ui) {
            update(ui.values);
            if (hasInterval) {
                $("#specificSlider").slider("value", ui.values[0]);
            }
        }
        });
    } );

    $( function() {
        $( "#specificSlider" ).slider({
        min: 0,
        max: 1742,
        value: 0,
        change: function(event, ui) {
            if (!hasInterval) {
                $("#intervalSlider").slider("values", [ui.value, ui.value]);
            }
        },
        slide: function(event, ui) {
            if (!hasInterval) {
                $("#intervalSlider").slider("values", [ui.value, ui.value]);
            }
        },
        });
    } );

    // var slider = document.getElementById("slider");
    var hasInterval = false;
    $("#intervalControls").hide();
    $("#intervalSlider").hide();
    var intervalToggle = document.getElementById("intervalToggle");
    intervalToggle.onclick = function() {
        if (hasInterval) {
            $("#intervalControls").hide();
            $("#specificControls").show();
            $("#intervalSlider").hide();
            $("#specificSlider").show();
            resetInterval(0);
        } else {
            $("#specificControls").hide();
            $("#intervalControls").show();
            $("#specificSlider").hide();
            $("#intervalSlider").show();
            resetInterval(60);
        }
        hasInterval = !hasInterval;
    };    

    var play = document.getElementById("toggleIcon");
    var isPlaying = false;
    var speed = 60;
    function autoRun() {
        if (isPlaying) {
            var endValue = stepUp(parseInt(1));
            if (endValue == 1742) {
                isPlaying = false;
                play.src = "../icon/play.svg";
                play.title = "Play"
                popupList.forEach(function (element) {
                    mymap.openPopup(element);
                });
            }
        }
    }
    var playInterval = setInterval(autoRun, speed);

    play.onclick = function () {
        isPlaying = !isPlaying;
        if (isPlaying) {
            play.src = "../icon/pause.svg";
            play.title = "Pause";
            popupList.forEach(function (element) {
                mymap.closePopup(element);
            });
        } else {
            play.src = "../icon/play.svg";
            play.title = "Play"
            popupList.forEach(function (element) {
                mymap.openPopup(element);
            });
        }
    };

    var speed = document.getElementById("speed");
    var currentMultiplier = 1;
    speed.onclick = function () {
        if (currentMultiplier < 2) {
            currentMultiplier += 0.5;
            speed -= 15;
        } else {
            currentMultiplier = 0.5;
            speed = 75;
        }

        clearInterval(playInterval);
        playInterval = setInterval(autoRun, speed);
        $("#speed").html(currentMultiplier + "x");
    }

    var stepForward = document.getElementById("stepForward");
    var stepBackward = document.getElementById("stepBackward");
    stepForward.onclick = function () {	
        stepUp(parseInt(1));
    }
    stepBackward.onclick = function () {
        stepDown(parseInt(1));
    }

    var prevDay = document.getElementById("prevDay");
    var nextDay = document.getElementById("nextDay");
    prevDay.onclick = function () {
        stepDown(601);
    }
    nextDay.onclick = function () {
        stepUp(601);
    }
    prevDay.onmouseenter = function () {
        prevDay.src = "../icon/hoverprev.svg";
    }
    prevDay.onmouseleave = function () {
        prevDay.src = "../icon/prev.svg";
    }
    nextDay.onmouseenter = function () {
        nextDay.src = "../icon/hovernext.svg";
    }
    nextDay.onmouseleave = function () {
        nextDay.src = "../icon/next.svg";
    }

    var intStartDay = document.getElementById("intStartDay");
    var intStartTime = document.getElementById("intStartTime");
    var intEndDay = document.getElementById("intEndDay");
    var intEndTime = document.getElementById("intEndTime");
    var interval = document.getElementById("interval");
    var specDay =  document.getElementById("specDay");
    var specTime =  document.getElementById("specTime");

    intStartDay.addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            changeStartTime();
        }
    });

    intStartTime.addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            changeStartTime();
        }
    });

    intEndDay.addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            changeEndTime();
        }
    });

    intEndTime.addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            changeEndTime();
        }
    });

    interval.addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            changeInterval();
        }
    });

    specDay.addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            changeSpecTime();
        }
    });

    specTime.addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            changeSpecTime();
        }
    });
    

</script>
</body>