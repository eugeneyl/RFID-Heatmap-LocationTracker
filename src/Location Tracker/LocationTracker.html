<head>
    <meta name="viewport" id="vp" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width" />
    <meta charset="utf-8" />
    <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <!-- <script src="https://code.jquery.com/jquery-1.8.0.min.js"></script> -->
    <link rel="stylesheet" href="../../jquery-ui/jquery-ui.css">
    <script src="../../jquery-ui/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="../../styles/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
        integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
        crossorigin=""></script>
    <script src="../../helper/Leaflet.ImageOverlay.Rotated.js"></script>
    <script src="../../helper/leaflet-heat.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet">
    <link rel = "stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css"/>
</head>

<link rel="stylesheet" href="../../styles/locationTracker.css" />

<body>
    <div>
        <div id = mapWrapper>
            <div id="mapid"></div>
            <div id="button-wrapper">
                <input type="button" value="Heatmap" class = "mode" onclick="window.location.href = '../Heatmap/Heatmap.html';"/>
            </div>
        </div>
        <div id= "controlBox">
            <div class="search" >
                <span class="fa fa-search"></span>
                <input id="searchID" placeholder="Search for Name/ID">
            </div>
            <div style="margin-top:23px">
                <span id = "attendeeName" class = "nameText"></span></br>
                <span id = "attendeeID" class = "idText"></span>
            </div>
            <div id = "summaryPanel" class = "summaryPanel">
                <span id = "summaryHeader" class = "controlBoxText"></span></br>
                <span id = "noAlley" class = "controlBoxText" ></span></br>
                <span id = "mostVisited" class = "controlBoxText"></span>
            </div>
            <div id = "recordsTable" class = "recordsTable">
                <table id = "table" style="width:100%; border-collapse:collapse">
                    <tbody id=>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>

<script src="DataSet.js"></script>
<script> //Parsing data
function parseTimeString(min, hour) {
    var smin;
    var shour;
    if (min < 10) {
        smin = "0" + min;
    } else {
        smin = min.toString();
    }
    if (hour < 10) {
        shour = "0" + hour;
    } else {
        shour = hour.toString();
    }
    return shour+smin;
}

var parsedData = [];

rawData.forEach (function (data) {
    var dateTime = new Date(data.captured_time_minute);
    var day = parseInt(dateTime.getDate()) - 18;
    var hour = dateTime.getHours();
    var min = dateTime.getMinutes();
    var timeString = parseTimeString(min, hour);
    var shownTime = "Day " + day + ", " + timeString;

    var alley = -1;
    if (data.location == "Alley 1") {
      alley = 0;
    } else if (data.location == "Alley 2") {
      alley = 1;
    } else if (data.location == "Alley 3") {
      alley = 2;
    } else if (data.location == "Alley 4") {
      alley = 3;
    } else if (data.location == "Alley 5") {
      alley = 4;
    } else if (data.location == "Alley 6") {
      alley = 5;
    } else if (data.location == "Alley 7") {
      alley = 6;
    } else if (data.location == "Alley 8") {
      alley = 7;
    }
    parsedData.push({
        "time" :  shownTime,
        "id" : data.tag,
        "name" : data.person,
        "alley" : alley 
    });
});
</script>
<script> //map initialisation
    var point1 = L.latLng(1.334227, 103.955138),
        point3 = L.latLng(1.331125, 103.955138),
        point2 = L.latLng(1.334227, 103.961874);
    bounds = L.latLngBounds(point2, point3);

    var mymap = L.map('mapid', {
        center: [1.332469, 103.957427],
        zoom: 18.42,
        // maxBounds: bounds
    });

    mymap.setMaxBounds(bounds);

    L.tileLayer('', {
        'attribution': 'Map data &copy; OpenStreetMap contributors',
        maxZoom: 22,
        minZoom: 18.4,
    }).addTo(mymap);

    var overlay = L.imageOverlay.rotated("../../icon/Map.svg", point1, point2, point3, {
        opacity: 1,
        interactive: true,
        attribution: "Floor plan of tyreexpo"
    }).addTo(mymap);
    
    var alleyCoordinates = [
        {"alley" : 1, "lat" : 1.333277, "long" : 103.956274},
        {"alley" : 2, "lat" : 1.332569, "long" : 103.956542},
        {"alley" : 3, "lat" : 1.331904, "long" : 103.956542},
        {"alley" : 4, "lat" : 1.331877, "long" : 103.957272},
        {"alley" : 5, "lat" : 1.331893, "long" : 103.958575},
        {"alley" : 6, "lat" : 1.332569, "long" : 103.958441},
        {"alley" : 7, "lat" : 1.333239, "long" : 103.958151},
        {"alley" : 8, "lat" : 1.332869, "long" : 103.957331},
    ];

    var pointList = [];
    for (var i = 0; i < 8; i++) {
        var point = L.latLng(alleyCoordinates[i].lat, alleyCoordinates[i].long);
        pointList.push(point);
    }


</script>
<script>
    function iterateRecords() {
        var queryResult = [];
        var alleyCount = [];
        for (var i = 0; i < 8; i++) {
            alleyCount.push({
                "number" : i,
                "count": 0
            });
        }
        var attendeeName;
        var attendeeId;
        parsedData.forEach(function (data) {
            if (data.id == search.value 
                || data.name.toLowerCase() == search.value.toLowerCase()) {
                queryResult.push({
                    "time" : data.time,
                    "alley" : data.alley
                })
                attendeeName = data.name.toLowerCase();
                attendeeId = data.id;
                alleyCount[data.alley].count++;
            }
        });
        if (queryResult.length == 0) {
            alert("Name/ID not found.");
            return;
        }
        $('tbody').html("");
        addHeader();
        queryResult.forEach(function (data) {
            addRow(data);
        });

        $("#attendeeName").html("Name: <b>" + attendeeName + "</b>");
        $("#attendeeID").html("ID: <b>" + attendeeId + "</b>");
        var noAlley = 0;

        alleyCount.sort(function (a, b) {
            return b.count-a.count;
        });

        var frequent = alleyCount[0].number + 1;
        for (var i = 0; i < 8; i++) {
            if (alleyCount[i].count > 0) {
                noAlley ++;
            }
            if (i != 0 && alleyCount[i].count == alleyCount[0].count) {
                var alley = alleyCount[i].number + 1;
                frequent = frequent + ", " + alley;
            }
        }
        $("summaryHeader").html("<u>Summary</u>");
        $("#noAlley").html("Number of visited alleys: <b>" + noAlley + "</b>");
        $("#mostVisited").html("Most frequently visited alley: <b>" + frequent + "</b>");

        var table = document.getElementById("table");
        for(var i = 1; i < table.rows.length; i++){
            var marker;
            table.rows[i].onmouseenter = function() {
                rowIndex = this.rowIndex - 1;
                marker = L.marker(pointList[queryResult[rowIndex].alley]).addTo(mymap);
            }
            table.rows[i].onmouseleave = function() {
                mymap.closePopup(marker);
            }
        }
    }

    function addRow(data) {
        if (!document.getElementsByTagName) return;
        tabBody = document.getElementsByTagName("tbody").item(0);
        row = document.createElement("tr");
        row.className = "bodyrow";
        cell1 = document.createElement("td");
        cell2 = document.createElement("td");
        textnode1 = document.createTextNode(data.time);
        textnode2 = document.createTextNode(data.alley + 1);
        cell1.appendChild(textnode1);
        cell2.appendChild(textnode2);
        row.appendChild(cell1);
        row.appendChild(cell2);
        tabBody.appendChild(row);
    }

    function addHeader() {
        if (!document.getElementsByTagName) return;
        tabBody = document.getElementsByTagName("tbody").item(0);
        row = document.createElement("tr");
        cell1 = document.createElement("th");
        cell2 = document.createElement("th");
        textnode1 = document.createTextNode("Time");
        textnode2 = document.createTextNode("Alley");
        cell1.appendChild(textnode1);
        cell2.appendChild(textnode2);
        row.appendChild(cell1);
        row.appendChild(cell2);
        tabBody.appendChild(row);
    }

    var search = document.getElementById("searchID");
    search.addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            iterateRecords();
        }
    });

</script>

